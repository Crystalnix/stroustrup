

{% extends 'book_library/books_mainpage.html' %}
{% block title %}{{ book.title }}{% endblock %}
{% block location %}Book: {{ book.title }}{% endblock %}
{% block link_extension %}
    {% load static %}


{% endblock %}

{% block content %}



    <div class="main_container">

        <div class="panel panel-default">
            <div class="panel-heading">
                <span class="glyphicon glyphicon-book"></span> <a class="title">{{ book.title }}</a>
            </div>
            <div class="panel-body">
                <div class="media">
                    <div class="col-md-1">

                                {% if book.picture%}
                                    <a TARGET="_blank" href="{{ book.picture.url }}" class="thumbnail">
                                        <img data-src="holder.js/100%x320" src="{{ book.picture.url }}" alt="Image">
                                    </a>

                                {% endif%}
                                {% if not book.picture%}

                                    <a  TARGET="_blank"  href="{% static 'image/book_index.png'%}" class="thumbnail">
                                        <img data-src="holder.js/100%x180" src="{% static 'image/book_index.png' %}" alt="Image">
                                    </a>

                                {% endif %}

                                {% if book.file %}
                                    <a TARGET="_blank" href="{{ book.file.url }}" class="thumbnail"> Download </a>

                                {%  endif %}

                    </div>
                    <div class="media-body">
                        <h4 class="media-heading pull-left"> ID: {{ book.id }}</h4>

                        <h4 class="media-heading pull-right">ISBN: {{ book.isbn }} </h4>
                        <hr/>

                        <ul id="myTab" class="nav nav-tabs">
                            <li class="active"><a href="#authors" data-toggle="tab">Authors <span class="glyphicon glyphicon-user"></span></a></li>
                            <li><a href="#description" data-toggle="tab">Description <span class="glyphicon glyphicon-info-sign"></span></a></li>
                            <li><a href="#version" data-toggle="tab">Versions <span class="glyphicon glyphicon-tasks"></span> </a></li>
                            <li><a href="#tags" data-toggle="tab">Tags <span class="glyphicon glyphicon-tags"></span></a></li>
                        </ul>
                        <div id="myTabContent" class="tab-content">
                            <div class="tab-pane fade in active" id="authors">
                                {% for author in book.authors.all %}
                                    <li class="list-group-item">
                                        <a class="author" href="{% url "books:author" author.id %}">
                                            <span class="glyphicon glyphicon-chevron-right"></span> {{ author.first_name }} {{ author.last_name }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </div>
                            <div class="tab-pane fade" id="description">
                                <div class="panel panel-info">
                                    <div class="panel-body">
                                        {{ book.description }}
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="version">
                                <div class="panel panel-info">
                                    <div class="panel-body">
                                        <p>Paperbook:
                                            {% if book.paperback_version_exists   %}<span class="glyphicon glyphicon-ok-sign"></span>
                                            {% else %} <span class="glyphicon glyphicon-remove-sign"></span>
                                            {% endif %}
                                        </p>

                                        <p>E-book:
                                            {% if book.e_version_exists %}<span class="glyphicon glyphicon-ok-sign"></span>
                                            {% else %} <span class="glyphicon glyphicon-remove-sign"></span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>

                            </div>
                            <div class="tab-pane fade" id="tags">
                                <div class="panel panel-info">
                                    <div class="panel-body">
                                        {% for tag in book.tags.all %}

                                            <a href="{% url 'books:tag' tag.id %}" class="btn btn-primary tag">{{ tag.tag }} </a>,

                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
                <hr/>
            <div class="row">
                <div class="col-md-7">
                <div class="well well-lg">
                    <div class="container">
                        <h4 class="col-sm-offset-0">
                            Status:
                            {% if book.busy %}
                                {% ifequal user book.taken_by %}
                                    <span  id="status_row" class="label label-warning take_return_button"> Mine </span></h4>
                                    <h4 id="owner">Owner:
                                        <a href="{% url "profile:profile" book.taken_by.id %}"  class="author">You</a>
                                    </h4>

                                {% else %}
                                    <span id="status_row"  class="label label-danger take_return_button"> Busy </span>
                                </h4>
                                    <h4 id="owner">Owner:
                                        <a href="{% url "profile:profile" book.taken_by.id %}" class="author">
                                        {{ book.taken_by.username }}
                                        </a>
                                    </h4>
                                {% endifequal %}


                            {% else %}
                                <span id="status_row" class="label label-success take_return_button"> Free </span>
                        </h4>
                            {% endif %}



                        <h4 id="action">Action:
                            {% if not book.busy %}
                                <a  id="take_return_send_button"
                                    class="take_return_button btn btn-success  btn-lg"
                                    onclick="book_action('take','take/{{ book.id }}',{{ book.id }});">
                                    Take!
                                </a>
                            {% else %}
                                {% if user in book.users.all %}
                                    <a id="take_return_send_button"

                                       onclick="book_action('return','return/{{ book.id }}',{{ book.id }});"
                                       class="take_return_button btn btn-warning  btn-lg">
                                        Return...
                                    </a>
                                {% else %}
                                    <a id="take_return_send_button"

                                       onclick=" book_action('ask','ask_to_return/{{ book.id }}',{{ book.id }});"
                                       class="take_return_button btn btn-danger  btn-lg"> Send a request! </a>
                                {% endif %}
                            {% endif %}

                        </h4>
                    </div>
                </div>
                </div>
                <div class="col-md-5">

                    <div class="rating_{{ book.id }}">
                        <input type="hidden" class="val" value="{{ book.book_rating.common_rating }}"/>
                    </div>
                    <script>
                        var user_in_list_{{ book.id }}=false;
                        {%for elem in book.book_rating.all %}
                            {% ifequal elem.user_owner.id user.id%}
                                user_in_list_{{ book.id }}=true;

                            {% endifequal %} {% endfor %}

                        $('div.rating_'+'{{ book.id }}').rating({{ book.id }}, '{{ book.common_rating}}', '{{ book.votes_amount}}', user_in_list_{{ book.id }});

                    </script>
                </div>
            </div>
                <hr/>

                <div class="row">
                    <div class="col-md-12">
                        <div class="btn-group btn-group-lg ">
                            <a href=" {% url "books:story" book.id %}" class="btn btn-primary btn-lg">
                                Check a history of the book <span class="glyphicon glyphicon-list-alt"></span>
                            </a>
                            {% if user.is_staff %}
                            <div class="btn-group btn-group-lg">

                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                                    Edit book <span class="glyphicon glyphicon-edit"></span>
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a  href="{% url 'books:delete' book.id %}">Delete</a></li>
                                    <li><a  href="{% url 'books:change' book.id %}">Change</a></li>
                                </ul>
                            </div>
                            {% endif %}
                            <!-- Button trigger modal -->
                            <a data-toggle="modal" href="#comments_{{book.id}}" class="btn btn-primary btn-lg">
                                Comments <span class="glyphicon glyphicon-comment"></span>
                            </a>


                            <a href=" {% url "books:list"%}" class="btn btn-primary">
                                Fall back <span class="glyphicon glyphicon-chevron-down"></span>
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!--MODAL-->
        <div class="modal fade" id="comments_{{ book.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Share your opinion:</h4>
                    </div>
                    <div class="modal-body" id="row_panel{{ book.id }}">
                        {% if book.comments.all %}
                            {% for comment in book.comments.all %}
                                <div class="row">
                                    <span class="glyphicon glyphicon-time"> </span> {{comment.sent_time}}
                                    <div class="well well-sm">
                                        <a href="{% url 'profile:profile' comment.user.pk %}" class="text-primary">
                                            {{ comment.user }}:
                                        </a>
                                        {{ comment.comment }}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <h4 id="empty_board{{ book.id }}">
                                This is board is empty... Fix such situation <span class="glyphicon glyphicon-chevron-down"></span>
                            </h4>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <div class="row">
                            <div class="col-lg-6 pull-right">
                                <div class="input-group">
                                    <input id="input{{ book.id }}"
                                           onkeydown="enter(event, {{ book.id }}, {{ user.pk }})"
                                           onkeypress="enter(event, {{ book.id }}, {{ user.pk }})"
                                           type="text" class="form-control">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-primary"
                                                onclick="  comment({{ book.id }}, {{ user.pk }});">
                                            Send! <span class="glyphicon glyphicon-envelope"></span>
                                        </button>
                                    </span>
                                </div><!-- /input-group -->
                            </div><!-- /.col-lg-6 -->
                        </div>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->



    </div>


{% endblock %}

{% block extensions %}
    <script>
    $('div.rating').rating();
    </script>
{% endblock %}